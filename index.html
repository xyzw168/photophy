<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚úß photophy ‚úß</title>
    <style>
        :root { --pink: #ffafcc; --blue: #a2d2ff; --green: #caffbf; --yellow: #fdffb6; --purple: #cdb4db; }
        body {
            background-color: var(--blue); background-image: radial-gradient(var(--pink) 1px, transparent 1px);
            background-size: 25px 25px; font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; min-height: 100vh;
        }
        .window { background: white; border: 4px solid #000; box-shadow: 8px 8px 0px #000; width: 95%; max-width: 500px; margin-top: 10px; }
        .title-bar { background: linear-gradient(90deg, var(--purple), var(--pink)); color: white; padding: 8px 12px; font-weight: bold; border-bottom: 4px solid #000; display: flex; justify-content: space-between; }
        .content { padding: 12px; text-align: center; }
        .camera-section { display: flex; gap: 10px; margin-bottom: 15px; }
        #camera-box { position: relative; flex: 3; aspect-ratio: 4/3; background: #000; border: 3px solid #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }
        #adj-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; touch-action: none; cursor: move; background: #222; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: white; z-index: 100; text-shadow: 4px 4px 0px var(--pink); display: none; }
        .side-preview { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .mini-f { width: 100%; height: 70px; border: 2px solid #000; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 9px; }
        .mini-f img { width: 100%; height: 100%; object-fit: contain; }
        .label { font-size: 10px; font-weight: bold; margin: 5px 0; text-transform: uppercase; }
        .selector-group { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px; }
        .btn-opt { padding: 5px 8px; border: 2px solid #000; background: #eee; cursor: pointer; font-size: 9px; font-weight: bold; font-family: inherit; }
        .active { background: var(--pink) !important; color: white; box-shadow: 2px 2px 0px #000; }
        .main-btn { width: 100%; padding: 15px; background: var(--green); border: 3px solid #000; font-weight: bold; cursor: pointer; box-shadow: 4px 4px 0px #000; }
        #adjust-ui { display: none; background: #f9f9f9; padding: 10px; border: 2px dashed #000; margin-top: 10px; }
        #gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 25px; width: 95%; max-width: 500px; }
        .polaroid { background: white; padding: 8px; border: 2px solid #000; transform: rotate(var(--r)); margin-bottom: 20px; }
        .polaroid img { width: 100%; border: 1px solid #eee; margin-bottom: 8px; display: block; }
        #flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 999; }
        .flash-active { animation: flash-anim 0.3s; }
        @keyframes flash-anim { 0% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="flash"></div>
    <div class="window">
        <div class="title-bar"><span>üì∏ photophy</span><span>[X]</span></div>
        <div class="content">
            <div class="camera-section">
                <div id="camera-box">
                    <div id="countdown">3</div>
                    <video id="video" autoplay playsinline class="mirror"></video>
                    <canvas id="adj-canvas"></canvas>
                </div>
                <div class="side-preview">
                    <div class="label">Frame</div>
                    <div id="mini-frame" class="mini-f">None</div>
                    <button class="btn-opt" style="background:var(--yellow)" onclick="switchCam()">üîÑ SWAP</button>
                    <button class="btn-opt" style="background:var(--blue)" onclick="document.getElementById('file-in').click()">üìÅ LOAD</button>
                    <input type="file" id="file-in" hidden accept="image/*" onchange="loadFromGallery(event)">
                </div>
            </div>

            <div id="adjust-ui">
                <div class="label">Zoom & Drag Foto Galeri</div>
                <input type="range" id="zoom-range" min="0.1" max="2" step="0.01" value="1" style="width:100%">
                <button class="main-btn" style="background:var(--purple); margin-top:10px; padding:10px" onclick="confirmAdjust()">OK, USE THIS PHOTO</button>
            </div>

            <div id="controls-ui">
                <div class="label">1. Layout</div>
                <div class="selector-group">
                    <button class="btn-opt active" onclick="setLay('SINGLE',1,800,920,this)">SINGLE</button>
                    <button class="btn-opt" onclick="setLay('STRIP',3,400,1100,this)">STRIP</button>
                    <button class="btn-opt" onclick="setLay('GRID',4,800,1000,this)">GRID</button>
                    <button class="btn-opt" onclick="setLay('STORY3',3,1080,1920,this)">STORY 3</button>
                    <button class="btn-opt" onclick="setLay('STORY4',4,1080,1920,this)">STORY 4</button>
                </div>

                <div class="label">2. Filter</div>
                <div class="selector-group">
                    <button class="btn-opt active" onclick="setFilter('none', this)">Normal</button>
                    <button class="btn-opt" onclick="setFilter('sepia(0.6) contrast(1.1)', this)">Vintage</button>
                    <button class="btn-opt" onclick="setFilter('grayscale(1)', this)">B&W</button>
                    <button class="btn-opt" onclick="setFilter('hue-rotate(-20deg) saturate(1.2)', this)">Rosy</button>
                </div>

                <div class="label">3. Design</div>
                <div id="design-opts" class="selector-group"></div>
                <button id="snap" class="main-btn">‚ú® TAKE PHOTO ‚ú®</button>
            </div>
        </div>
    </div>
    <div id="gallery"></div>
    <canvas id="work-canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const adjCanvas = document.getElementById('adj-canvas');
        const adjCtx = adjCanvas.getContext('2d');
        const zoomRange = document.getElementById('zoom-range');
        let currentLay = { id: 'SINGLE', count: 1, w: 800, h: 920 };
        let frameURL = 'none', facing = 'user', photos = [], tempImg = new Image();
        let offX = 0, offY = 0, scale = 1, isDrag = false, startX, startY, currentFilter = 'none';

        async function init() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing } });
                video.srcObject = s;
                video.classList.toggle('mirror', facing === 'user');
                renderFrames('SINGLE');
            } catch(e) { alert("Camera Error"); }
        }

        function setLay(id, c, w, h, el) {
            currentLay = { id, count: c, w, h };
            updateActive(el, '#controls-ui .selector-group:first-of-type .btn-opt');
            renderFrames(id);
        }

        function setFilter(f, el) {
            currentFilter = f;
            video.style.filter = f === 'none' ? '' : f;
            updateActive(el, '#controls-ui .selector-group:nth-of-type(2) .btn-opt');
        }

        function updateActive(el, selector) {
            document.querySelectorAll(selector).forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function renderFrames(id) {
            const box = document.getElementById('design-opts'); box.innerHTML = '';
            const list = [{name:'None', url:'none'}, {name:'Frame 1', url:'https://i.ibb.co.com/fGzfpG5R/layphy1.png'}];
            list.forEach(f => {
                const b = document.createElement('button'); b.className = 'btn-opt'; b.innerText = f.name;
                b.onclick = () => { frameURL = f.url; document.getElementById('mini-frame').innerHTML = f.url==='none'?'None':`<img src="${f.url}">`; };
                box.appendChild(b);
            });
        }

        // AUTO CAPTURE
        document.getElementById('snap').onclick = async () => {
            photos = [];
            for(let i=0; i<currentLay.count; i++) {
                await timer(3);
                photos.push(autoGrab());
                flash();
            }
            renderFinal();
        };

        function timer(s) {
            return new Promise(res => {
                let c = s; const el = document.getElementById('countdown'); el.style.display = 'block';
                const t = setInterval(() => { el.innerText = c; if(c<=0){ clearInterval(t); el.style.display='none'; res(); } c--; }, 800);
            });
        }

        function autoGrab() {
            const c = document.createElement('canvas');
            let tw = 600, th = 450;
            if(currentLay.id==='STORY4') { tw=420; th=560; }
            c.width = tw; c.height = th;
            const ctx = c.getContext('2d');
            ctx.filter = currentFilter === 'none' ? 'none' : currentFilter;
            if(facing==='user') { ctx.translate(tw,0); ctx.scale(-1,1); }
            const vr = video.videoWidth/video.videoHeight, tr = tw/th;
            let sx, sy, sw, sh;
            if(vr > tr) { sw=video.videoHeight*tr; sh=video.videoHeight; sx=(video.videoWidth-sw)/2; sy=0; }
            else { sw=video.videoWidth; sh=video.videoWidth/tr; sx=0; sy=(video.videoHeight-sh)/2; }
            ctx.drawImage(video, sx, sy, sw, sh, 0, 0, tw, th);
            return c;
        }

        // GALLERY LOAD
        function loadFromGallery(e) {
            const r = new FileReader();
            r.onload = (f) => {
                tempImg = new Image();
                tempImg.onload = () => {
                    adjCanvas.width = 600; adjCanvas.height = 450;
                    adjCanvas.style.display = 'block';
                    document.getElementById('adjust-ui').style.display = 'block';
                    document.getElementById('controls-ui').style.display = 'none';
                    offX = 300; offY = 225; scale = 0.5;
                    drawAdj();
                };
                tempImg.src = f.target.result;
            };
            r.readAsDataURL(e.target.files[0]);
        }

        function drawAdj() {
            adjCtx.fillStyle = '#000'; adjCtx.fillRect(0,0,600,450);
            const w = tempImg.width * scale, h = tempImg.height * scale;
            adjCtx.filter = currentFilter === 'none' ? 'none' : currentFilter;
            adjCtx.drawImage(tempImg, offX - w/2, offY - h/2, w, h);
        }

        adjCanvas.onpointerdown = e => { isDrag=true; startX=e.clientX; startY=e.clientY; };
        window.onpointermove = e => { if(!isDrag) return; offX+=e.clientX-startX; offY+=e.clientY-startY; startX=e.clientX; startY=e.clientY; drawAdj(); };
        window.onpointerup = () => isDrag=false;
        zoomRange.oninput = e => { scale = e.target.value; drawAdj(); };

        function confirmAdjust() {
            const c = document.createElement('canvas'); c.width = 600; c.height = 450;
            c.getContext('2d').drawImage(adjCanvas, 0, 0);
            photos.push(c);
            adjCanvas.style.display = 'none';
            document.getElementById('adjust-ui').style.display = 'none';
            document.getElementById('controls-ui').style.display = 'block';
            if(photos.length >= currentLay.count) renderFinal();
        }

        async function renderFinal() {
            const c = document.getElementById('work-canvas'); const ctx = c.getContext('2d');
            c.width = currentLay.w; c.height = currentLay.h;
            ctx.fillStyle = "white"; ctx.fillRect(0,0,c.width,c.height);
            
            if(currentLay.id==='SINGLE') ctx.drawImage(photos[0], 50, 50, 700, 525);
            else if(currentLay.id==='STRIP') photos.forEach((p,i) => ctx.drawImage(p, 35, 50+(i*330), 330, 280));
            else if(currentLay.id==='GRID') { ctx.drawImage(photos[0],35,50,350,380); ctx.drawImage(photos[1],415,50,350,380); ctx.drawImage(photos[2],35,460,350,380); ctx.drawImage(photos[3],415,460,350,380); }
            else if(currentLay.id==='STORY3') photos.forEach((p,i) => ctx.drawImage(p, 100, 200+(i*520), 880, 480));
            else if(currentLay.id==='STORY4') { ctx.drawImage(photos[0],100,200,420,560); ctx.drawImage(photos[1],560,200,420,560); ctx.drawImage(photos[2],100,850,420,560); ctx.drawImage(photos[3],560,850,420,560); }

            if(frameURL!=='none') {
                const f = new Image(); f.crossOrigin = "anonymous"; f.src = frameURL;
                await new Promise(r => f.onload = r); ctx.drawImage(f,0,0,c.width,c.height);
            }
            const div = document.createElement('div'); div.className = 'polaroid'; div.style.setProperty('--r', (Math.random()*4-2)+'deg');
            div.innerHTML = `<img src="${c.toDataURL()}"><button class="btn-opt" style="width:100%; background:var(--blue)" onclick="save('${c.toDataURL()}')">SAVE</button>`;
            document.getElementById('gallery').prepend(div);
        }

        function save(url) { const a = document.createElement('a'); a.href=url; a.download='photo.png'; a.click(); }
        function flash() { document.getElementById('flash').classList.add('flash-active'); setTimeout(()=>document.getElementById('flash').classList.remove('flash-active'),300); }
        function switchCam() { facing = facing==='user'?'environment':'user'; init(); }
        init();
    </script>
</body>
</html>
