<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚úß photophy ‚úß</title>
    <style>
        :root {
            --pink: #ffafcc; --blue: #a2d2ff; --green: #caffbf; --yellow: #fdffb6; --purple: #cdb4db;
        }

        body {
            background-color: var(--blue); background-image: radial-gradient(var(--pink) 1px, transparent 1px);
            background-size: 25px 25px; font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0;
            overflow-x: hidden; min-height: 100vh;
        }

        .window {
            background: white; border: 4px solid #000; box-shadow: 8px 8px 0px #000;
            width: 95%; max-width: 500px; margin-top: 10px;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--purple), var(--pink));
            color: white; padding: 8px 12px; display: flex; justify-content: space-between;
            font-weight: bold; border-bottom: 4px solid #000; font-size: 14px;
        }

        .content { padding: 12px; text-align: center; }

        .camera-section {
            display: flex; gap: 10px; align-items: flex-start; justify-content: center; margin-bottom: 15px;
        }

        #camera-box {
            position: relative; flex: 3; aspect-ratio: 4/3; 
            background: #000; border: 3px solid #000; overflow: hidden;
            touch-action: none; cursor: move;
        }

        video, #preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #preview-img { display: none; object-fit: contain; } /* Untuk mode adjust */
        .mirror { transform: scaleX(-1); }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; color: white; font-weight: bold; z-index: 100;
            text-shadow: 4px 4px 0px var(--pink); display: none;
        }

        .side-preview {
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            background: #f9f9f9; border: 2px solid #000; padding: 5px;
        }

        #frame-mini-preview {
            width: 100%; height: 80px; border: 1px solid #000; background: #eee;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #frame-mini-preview img { width: 100%; height: 100%; object-fit: contain; }

        .label { font-size: 10px; font-weight: bold; margin: 10px 0 5px 0; text-transform: uppercase; }
        .selector-group { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; margin-bottom: 8px; }
        
        .btn-option {
            padding: 4px 8px; border: 2px solid #000; background: #eee;
            cursor: pointer; font-size: 9px; font-weight: bold;
        }
        .active { background: var(--pink) !important; color: white; transform: translateY(-2px); box-shadow: 2px 2px 0px #000; }

        .main-btn {
            width: 100%; padding: 15px; background: var(--green); border: 3px solid #000;
            font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 4px 4px 0px #000; margin-top: 5px;
        }

        .adjust-controls { display: none; margin-top: 10px; background: #eee; padding: 10px; border: 2px dashed #000; }
        
        #gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 25px; width: 95%; max-width: 500px; }
        .polaroid { background: white; padding: 8px; border: 2px solid #000; transform: rotate(var(--r)); margin-bottom: 20px; }
        .polaroid img { width: 100%; border: 1px solid #eee; margin-bottom: 8px; display: block; }

        input[type="range"] { width: 100%; accent-color: var(--pink); }
    </style>
</head>
<body>

    <div class="window">
        <div class="title-bar"><span>üì∏ photophy pro</span><span>[X]</span></div>
        <div class="content">
            <div class="camera-section">
                <div id="camera-box" id="capture-area">
                    <div id="countdown">3</div>
                    <video id="video" autoplay playsinline class="mirror"></video>
                    <canvas id="adjust-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none;"></canvas>
                </div>
                <div class="side-preview">
                    <div class="label" style="margin-top:0">Frame</div>
                    <div id="frame-mini-preview">None</div>
                    <button class="btn-option" style="margin-top:5px; width:100%; background:var(--yellow)" onclick="switchCamera()">üîÑ SWAP</button>
                    <button class="btn-option" style="margin-top:5px; width:100%; background:var(--blue)" onclick="document.getElementById('file-input').click()">üìÅ LOAD</button>
                    <input type="file" id="file-input" hidden accept="image/*" onchange="handleUpload(event)">
                </div>
            </div>

            <div class="adjust-controls" id="adj-ctrl">
                <div class="label">Zoom & Position</div>
                <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1">
                <button class="main-btn" style="background:var(--purple); font-size:12px; padding:8px" onclick="finalizePhoto()">‚úÖ DONE / NEXT PHOTO</button>
            </div>

            <div id="main-ui">
                <div class="label">1. Layout</div>
                <div class="selector-group">
                    <button class="btn-option active" onclick="selectLayout('SINGLE', 1, 800, 900, this)">SINGLE</button>
                    <button class="btn-option" onclick="selectLayout('STRIP', 3, 400, 1100, this)">STRIP</button>
                    <button class="btn-option" onclick="selectLayout('STORY4', 4, 1080, 1920, this)">STORY 4</button>
                </div>
                <div class="label">2. Design</div>
                <div id="frame-options" class="selector-group"></div>
                <button id="snap" class="main-btn">‚ú® TAKE PHOTO ‚ú®</button>
            </div>
        </div>
    </div>

    <div id="gallery"></div>
    <canvas id="final-canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const adjCanvas = document.getElementById('adjust-canvas');
        const adjCtx = adjCanvas.getContext('2d');
        const zoomSlider = document.getElementById('zoom-slider');
        const snapBtn = document.getElementById('snap');
        
        let currentLayout = { id: 'SINGLE', count: 1, w: 800, h: 900 };
        let selectedFrameURL = 'none';
        let useFacingMode = 'user';
        let capturedImages = [];
        let tempImg = new Image();
        
        // State for Adjustment
        let imgX = 0, imgY = 0, imgScale = 1;
        let isDragging = false, lastX, lastY;

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: useFacingMode } });
            video.srcObject = stream;
        }

        function selectLayout(id, count, w, h, el) {
            currentLayout = { id, count, w, h };
            document.querySelectorAll('.btn-option').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderFrames(id);
        }

        function renderFrames(id) {
            const frames = {
                'SINGLE': [{name:'None', url:'none'}, {name:'Pola', url:'https://i.ibb.co.com/fGzfpG5R/layphy1.png'}],
                'STRIP': [{name:'None', url:'none'}, {name:'Strip', url:'https://i.ibb.co.com/fGzfpG5R/layphy1.png'}],
                'STORY4': [{name:'None', url:'none'}, {name:'IG4', url:'https://i.ibb.co.com/Yn4fKQv/layphy2.png'}]
            };
            const container = document.getElementById('frame-options');
            container.innerHTML = '';
            frames[id].forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'btn-option'; btn.innerText = f.name;
                btn.onclick = () => { selectedFrameURL = f.url; document.getElementById('frame-mini-preview').innerHTML = f.url==='none'?'None':`<img src="${f.url}">`; };
                container.appendChild(btn);
            });
        }

        // Handle Capture
        snapBtn.onclick = async () => {
            capturedImages = [];
            takeNext();
        };

        async function takeNext() {
            if (capturedImages.length < currentLayout.count) {
                let count = 3;
                const cd = document.getElementById('countdown');
                cd.style.display = 'block';
                const timer = setInterval(() => {
                    cd.innerText = count;
                    if (count <= 0) {
                        clearInterval(timer); cd.style.display = 'none';
                        captureToAdjust();
                    }
                    count--;
                }, 800);
            } else {
                renderFinal();
            }
        }

        function captureToAdjust() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
            const tCtx = tempCanvas.getContext('2d');
            if(useFacingMode==='user') { tCtx.translate(tempCanvas.width,0); tCtx.scale(-1,1); }
            tCtx.drawImage(video, 0, 0);
            tempImg.src = tempCanvas.toDataURL();
            tempImg.onload = () => { startAdjustMode(); };
        }

        function handleUpload(e) {
            const reader = new FileReader();
            reader.onload = (f) => { tempImg.src = f.target.result; tempImg.onload = () => startAdjustMode(); };
            reader.readAsDataURL(e.target.files[0]);
        }

        function startAdjustMode() {
            video.style.display = 'none';
            adjCanvas.style.display = 'block';
            document.getElementById('adj-ctrl').style.display = 'block';
            document.getElementById('main-ui').style.display = 'none';
            
            // Reset position
            imgX = adjCanvas.width/2; imgY = adjCanvas.height/2; imgScale = 1;
            drawAdjust();
        }

        function drawAdjust() {
            adjCtx.clearRect(0,0,adjCanvas.width, adjCanvas.height);
            const sw = tempImg.width * imgScale;
            const sh = tempImg.height * imgScale;
            adjCtx.drawImage(tempImg, imgX - sw/2, imgY - sh/2, sw, sh);
        }

        // Drag & Zoom Events
        adjCanvas.onpointerdown = (e) => { isDragging = true; lastX = e.clientX; lastY = e.clientY; };
        window.onpointermove = (e) => {
            if(!isDragging) return;
            imgX += e.clientX - lastX; imgY += e.clientY - lastY;
            lastX = e.clientX; lastY = e.clientY; drawAdjust();
        };
        window.onpointerup = () => isDragging = false;
        zoomSlider.oninput = (e) => { imgScale = e.target.value; drawAdjust(); };

        function finalizePhoto() {
            const outCanvas = document.createElement('canvas');
            outCanvas.width = 600; outCanvas.height = 450;
            const oCtx = outCanvas.getContext('2d');
            
            // Re-draw based on adjusted position
            const ratio = 600 / adjCanvas.clientWidth;
            const sw = tempImg.width * imgScale * ratio;
            const sh = tempImg.height * imgScale * ratio;
            oCtx.drawImage(tempImg, (imgX * ratio) - sw/2, (imgY * ratio) - sh/2, sw, sh);
            
            capturedImages.push(outCanvas);
            
            // Reset UI
            video.style.display = 'block';
            adjCanvas.style.display = 'none';
            document.getElementById('adj-ctrl').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            
            if(capturedImages.length < currentLayout.count) takeNext();
            else renderFinal();
        }

        async function renderFinal() {
            const fCanvas = document.getElementById('final-canvas');
            const ctx = fCanvas.getContext('2d');
            fCanvas.width = currentLayout.w; fCanvas.height = currentLayout.h;
            ctx.fillStyle = "white"; ctx.fillRect(0,0,fCanvas.width, fCanvas.height);

            if(currentLayout.id === 'SINGLE') ctx.drawImage(capturedImages[0], 50, 50, 700, 550);
            else if(currentLayout.id === 'STRIP') capturedImages.forEach((img, i) => ctx.drawImage(img, 35, 50+(i*330), 330, 280));
            else if(currentLayout.id === 'STORY4') {
                ctx.drawImage(capturedImages[0], 100, 200, 420, 560); ctx.drawImage(capturedImages[1], 560, 200, 420, 560);
                ctx.drawImage(capturedImages[2], 100, 850, 420, 560); ctx.drawImage(capturedImages[3], 560, 850, 420, 560);
            }

            if(selectedFrameURL !== 'none') {
                const fImg = new Image(); fImg.crossOrigin="anonymous"; fImg.src = selectedFrameURL;
                await new Promise(r => fImg.onload = r);
                ctx.drawImage(fImg, 0, 0, fCanvas.width, fCanvas.height);
            }

            const div = document.createElement('div');
            div.className = 'polaroid'; div.style.setProperty('--r', (Math.random()*4-2)+'deg');
            div.innerHTML = `<img src="${fCanvas.toDataURL()}"><button class="btn-option" style="width:100%; background:var(--blue)" onclick="downloadImg('${fCanvas.toDataURL()}')">SAVE</button>`;
            document.getElementById('gallery').prepend(div);
        }

        function downloadImg(url) { const a = document.createElement('a'); a.href = url; a.download = 'photo.png'; a.click(); }
        function switchCamera() { useFacingMode = useFacingMode==='user'?'environment':'user'; startCamera(); }
        
        startCamera(); renderFrames('SINGLE');
    </script>
</body>
</html>
